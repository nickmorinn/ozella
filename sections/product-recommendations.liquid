{%- liquid
  assign recommend_products = true

  if recommendations.products and recommendations.products_count > 0
    assign related_collection = recommendations
  endif

  assign number_of_products = section.settings.related_count
-%}

{%- style -%}
  #Recommendations-{{ section.id }} .section-header {
    align-items: center;
    display: flex;
    gap: 12px;
    margin-bottom: 14px;
  }

  #Recommendations-{{ section.id }} .section-header__title {
    flex: 1 1 auto;
  }

  #Recommendations-{{ section.id }} .product-recommendations__nav {
    display: none;
    flex: 0 0 auto;
    gap: 8px;
    margin-left: 8px;
  }

  #Recommendations-{{ section.id }} .product-recommendations__nav.is-visible {
    display: flex;
  }

  #Recommendations-{{ section.id }} .product-recommendations__arrow.hide {
    display: none;
  }

  #Recommendations-{{ section.id }} .grid-overflow-wrapper {
    overflow-x: hidden;
    overflow-y: hidden;
    scrollbar-width: none;
  }

  #Recommendations-{{ section.id }} .grid-overflow-wrapper::-webkit-scrollbar {
    display: none;
  }

  #Recommendations-{{ section.id }} .grid-overflow-wrapper .grid {
    display: flex;
    flex-wrap: nowrap;
    margin-left: -10px;
    white-space: nowrap;
  }

  #Recommendations-{{ section.id }} .grid-overflow-wrapper .grid > .grid__item {
    display: inline-block;
    flex: 0 0 25%;
    float: none;
    padding-left: 10px;
    white-space: normal;
    width: 25%;
  }

  @media only screen and (max-width: 768px) {
    #Recommendations-{{ section.id }} .product-recommendations__nav,
    #Recommendations-{{ section.id }} .product-recommendations__nav.is-visible {
      display: none;
    }

    #Recommendations-{{ section.id }} .grid-overflow-wrapper {
      overflow-x: scroll;
    }

    #Recommendations-{{ section.id }} .grid-overflow-wrapper .grid {
      margin-left: -6px;
    }

    #Recommendations-{{ section.id }} .grid-overflow-wrapper .grid > .grid__item {
      flex: 0 0 74vw;
      padding-left: 8px;
      width: 74vw;
    }

    #Recommendations-{{ section.id }} .grid-overflow-wrapper .grid > .grid__item:first-child {
      margin-left: 8px;
    }

    #Recommendations-{{ section.id }} .grid-overflow-wrapper .grid > .grid__item:last-child:after {
      margin-right: 8px;
    }

    #Recommendations-{{ section.id }} .grid-overflow-wrapper .grid > .grid__item {
      font-size: 1rem;
    }

    #Recommendations-{{ section.id }} .grid-overflow-wrapper .grid-product__price {
      font-size: calc(var(--typeBaseSize) * 0.85);
    }
  }
{%- endstyle -%}

<product-recommendations
  id="Recommendations-{{ section.id }}"
  data-section-id="{{ section.id }}"
  data-section-type="product-recommendations"
  data-enable="{{ recommend_products }}"
  data-product-id="{{ product.id }}"
  data-intent="related"
  data-url="{{ routes.product_recommendations_url }}?section_id={{ section.id }}&product_id={{ product.id }}&limit={{ number_of_products }}"
  data-limit="{{ number_of_products }}">

  <div
    data-section-id="{{ product.id }}"
    data-subsection
    data-section-type="collection-grid"
    class="index-section">
    <div class="page-width">
      <header class="section-header">
        <h3 class="section-header__title">
          {{ section.settings.product_recommendations_heading }}
        </h3>
        <div class="product-recommendations__nav" data-related-recommendations-nav>
          <button
            type="button"
            class="btn btn--body btn--circle product-recommendations__arrow product-recommendations__arrow--prev hide"
            data-related-recommendations-prev
            aria-label="{{ 'general.pagination.previous' | t }}">
            <svg aria-hidden="true" focusable="false" role="presentation" class="icon icon--wide icon-arrow-left" viewBox="0 0 50 15"><title>icon-left-arrow</title><path d="M50 5.38v4.25H15V15L0 7.5 15 0v5.38Z"/></svg>
          </button>
          <button
            type="button"
            class="btn btn--body btn--circle product-recommendations__arrow product-recommendations__arrow--next"
            data-related-recommendations-next
            aria-label="{{ 'general.pagination.next' | t }}">
            <svg aria-hidden="true" focusable="false" role="presentation" class="icon icon--wide icon-arrow-right" viewBox="0 0 50 15"><title>icon-right-arrow</title><path d="M0 9.63V5.38h35V0l15 7.5L35 15V9.63Z"/></svg>
          </button>
        </div>
      </header>
    </div>

    <div class="page-width page-width--flush-small">
      <div class="grid-overflow-wrapper" data-related-recommendations-overflow>
        {%- if recommend_products -%}
          <div class="product-recommendations-placeholder">
            {% comment %}
              This content is visually hidden and replaced when recommended products show up
            {% endcomment %}
            <div class="grid grid--uniform visually-invisible" aria-hidden="true">
              {%- render 'product-grid-item',
                product: product,
                quick_shop_enable: settings.quick_shop_enable
              -%}
            </div>
          </div>
        {%- endif -%}
        {%- if related_collection.products_count > 0 -%}
          <div class="product-recommendations page-width">
            <div class="grid grid--uniform" data-aos="overflow__animation">
              {%- for product in related_collection.products limit: number_of_products -%}
                {% comment %} On smaller screen sizes, 39vw is used for grid items in the CSS {% endcomment %}
                {%- render 'product-grid-item',
                  product: product,
                  per_row: 4,
                  quick_shop_enable: settings.quick_shop_enable,
                  fallback: '39vw',
                -%}
              {%- endfor -%}
            </div>
          </div>
        {%- endif -%}
      </div>
    </div>
  </div>
</product-recommendations>

<script>
  (function() {
    var section = document.getElementById('Recommendations-{{ section.id }}');
    if (!section) {
      return;
    }

    var overflow = section.querySelector('[data-related-recommendations-overflow]');
    var nav = section.querySelector('[data-related-recommendations-nav]');
    var prevButton = section.querySelector('[data-related-recommendations-prev]');
    var nextButton = section.querySelector('[data-related-recommendations-next]');

    if (!overflow || !nav || !prevButton || !nextButton) {
      return;
    }

    var getScrollAmount = function() {
      var cards = overflow.querySelectorAll('.grid > .grid__item');

      if (!cards.length) {
        return overflow.clientWidth;
      }

      if (cards.length > 1) {
        var distance = cards[1].offsetLeft - cards[0].offsetLeft;

        if (distance > 0) {
          return distance;
        }
      }

      return cards[0].getBoundingClientRect().width;
    };

    var updateButtons = function() {
      var isDesktop = window.matchMedia('(min-width: 769px)').matches;
      var maxScrollLeft = overflow.scrollWidth - overflow.clientWidth;
      var hasOverflow = maxScrollLeft > 2;
      var atStart = overflow.scrollLeft <= 2;
      var atEnd = overflow.scrollLeft >= maxScrollLeft - 2;

      nav.classList.toggle('is-visible', hasOverflow && isDesktop);
      prevButton.classList.toggle('hide', atStart || !hasOverflow || !isDesktop);
      nextButton.classList.toggle('hide', atEnd || !hasOverflow || !isDesktop);
    };

    var scrollByCard = function(direction) {
      overflow.scrollBy({
        left: getScrollAmount() * direction,
        behavior: 'smooth'
      });
    };

    prevButton.addEventListener('click', function() {
      scrollByCard(-1);
    });

    nextButton.addEventListener('click', function() {
      scrollByCard(1);
    });

    overflow.addEventListener('scroll', updateButtons);
    document.addEventListener('recommendations:loaded', function(event) {
      if (!event.detail || event.detail.section !== section) {
        return;
      }

      updateButtons();
    });

    var resizeHandler = updateButtons;
    if (window.theme && theme.utils && typeof theme.utils.debounce === 'function') {
      resizeHandler = theme.utils.debounce(150, updateButtons);
    }
    window.addEventListener('resize', resizeHandler);

    updateButtons();
  })();
</script>

{% schema %}
{
  "name": "t:sections.product-recommendations.name",
  "settings": [
    {
      "type": "paragraph",
      "content": "t:sections.product-recommendations.settings.show_product_recommendations.info"
    },
    {
      "type": "text",
      "id": "product_recommendations_heading",
      "label": "t:sections.product-recommendations.settings.product_recommendations_heading.label",
      "default": "More Like This"
    },
    {
      "type": "range",
      "id": "related_count",
      "label": "t:sections.product-recommendations.settings.related_count.label",
      "default": 6,
      "min": 2,
      "max": 6,
      "step": 1
    },
    {
      "type": "range",
      "id": "products_per_row",
      "label": "t:sections.product-recommendations.settings.products_per_row.label",
      "default": 3,
      "min": 2,
      "max": 5,
      "step": 1
    }
  ],
  "disabled_on": {
    "groups": ["footer", "header", "custom.popups"]
  }
}
{% endschema %}
